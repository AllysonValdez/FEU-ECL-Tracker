import React, { useEffect, useMemo, useState } from "react";
// FEU GradTrack â€” Inspired by ComParEng Tools
// Single-file React app (Tailwind CSS). Data persists to localStorage.
// Highlights vs. v1: Pending/Active/Passed states, prereqs, conflict checker, ICS export, section table.

/**************** Types ****************/
type ID = string;

type Status = "Pending" | "Active" | "Passed"; // inspired naming

type Course = {
  id: ID;
  code: string;
  title: string;
  units: number;
  status: Status;
  term?: string; // e.g., "2025-1st"
  prereqs?: string[]; // course codes
  grade?: string; // optional display
};

type Section = {
  id: ID;
  courseCode: string; // link to Course.code
  section: string; // e.g., "A1"
  days: ("MO" | "TU" | "WE" | "TH" | "FR" | "SA" | "SU")[];
  start: string; // HH:MM 24h
  end: string;   // HH:MM 24h
  room?: string;
  color?: string; // css class for calendar tint
};

type Settings = {
  requiredUnits: number;
  maxUnitsPerTerm: number;
  summerUnitsCap: number;
};

type AppState = {
  version: number;
  settings: Settings;
  courses: Course[];
  sections: Section[]; // user-added, acts as "available sections" table
  chosen: ID[]; // chosen section ids for schedule
};

/**************** Helpers ****************/
const LS_KEY = "feu_gradtrack_inspired_v1";
const uid = () => Math.random().toString(36).slice(2, 10);
const daysOrder: Section["days"] = ["MO", "TU", "WE", "TH", "FR", "SA", "SU"] as any;
const parseHM = (t: string) => { const [h, m] = t.split(":").map(Number); return h * 60 + m; };
const fmtHM = (m: number) => `${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;

function initState(): AppState {
  const seedId = uid();
  return {
    version: 1,
    settings: { requiredUnits: 180, maxUnitsPerTerm: 23, summerUnitsCap: 9 },
    courses: [
      { id: uid(), code: "ECON111", title: "Intro to Economics", units: 3, status: "Pending" },
      { id: uid(), code: "LAW101", title: "Intro to Law", units: 3, status: "Pending" },
    ],
    sections: [
      { id: seedId, courseCode: "ECON111", section: "A1", days: ["MO","WE"], start: "09:00", end: "10:30", room: "Room 201" },
    ],
    chosen: [seedId],
  };
}

function useLocalState() {
  const [state, setState] = useState<AppState>(() => {
    try { const raw = localStorage.getItem(LS_KEY); if (raw) return JSON.parse(raw) as AppState; } catch {}
    return initState();
  });
  useEffect(() => { localStorage.setItem(LS_KEY, JSON.stringify(state)); }, [state]);
  return [state, setState] as const;
}

function unitsByStatus(courses: Course[]) {
  const s = { Pending: 0, Active: 0, Passed: 0 } as Record<Status, number>;
  for (const c of courses) s[c.status] += c.units;
  return s;
}

function checkPrereqBlocks(courses: Course[]) {
  // returns set of course codes that are blocked (prereqs not passed)
  const passed = new Set(courses.filter(c => c.status === "Passed").map(c => c.code));
  const blocked = new Set<string>();
  courses.forEach(c => {
    if (!c.prereqs || c.prereqs.length === 0) return;
    if (!c.prereqs.every(p => passed.has(p))) blocked.add(c.code);
  });
  return blocked;
}

function conflicts(a: Section, b: Section) {
  // overlap if any common day and time ranges intersect
  const common = a.days.filter(d => b.days.includes(d));
  if (!common.length) return false;
  const a1 = parseHM(a.start), a2 = parseHM(a.end), b1 = parseHM(b.start), b2 = parseHM(b.end);
  return a1 < b2 && b1 < a2;
}

function chosenConflicts(sections: Section[], chosen: ID[]) {
  const picks = sections.filter(s => chosen.includes(s.id));
  const out: [Section, Section][] = [];
  for (let i = 0; i < picks.length; i++) {
    for (let j = i + 1; j < picks.length; j++) {
      if (conflicts(picks[i], picks[j])) out.push([picks[i], picks[j]]);
    }
  }
  return out;
}

function exportICS(sections: Section[], chosen: ID[], title = "Class Schedule") {
  const picks = sections.filter(s => chosen.includes(s.id));
  const now = new Date();
  const dtstamp = now.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
  function makeEvent(s: Section) {
    // pick an arbitrary next Monday as start anchor
    const base = new Date();
    const dayIdx = { MO:1, TU:2, WE:3, TH:4, FR:5, SA:6, SU:0 } as any;
    const nowDay = base.getDay();
    const target = dayIdx[s.days[0]] ?? 1; // first meeting day
    const delta = (target - nowDay + 7) % 7;
    const date = new Date(base); date.setDate(base.getDate() + delta);
    const [sh, sm] = s.start.split(":").map(Number);
    const [eh, em] = s.end.split(":").map(Number);
    const dt = (d: Date, h: number, m: number) => {
      const x = new Date(d); x.setHours(h, m, 0, 0);
      return x.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
    };
    const uid = `${s.id}@feu-gradtrack`;
    const rrule = `RRULE:FREQ=WEEKLY;BYDAY=${s.days.join(",")}`;
    return [
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${dtstamp}`,
      `SUMMARY:${s.courseCode} ${s.section}`,
      s.room ? `LOCATION:${s.room}` : undefined,
      `DTSTART:${dt(date, sh, sm)}`,
      `DTEND:${dt(date, eh, em)}`,
      rrule,
      "END:VEVENT",
    ].filter(Boolean).join("\n");
  }
  const body = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//FEU GradTrack//EN",
    `X-WR-CALNAME:${title}`,
    ...picks.map(makeEvent),
    "END:VCALENDAR",
  ].join("\n");
  const blob = new Blob([body], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "feu-gradtrack-schedule.ics"; a.click();
  URL.revokeObjectURL(url);
}

/**************** UI ****************/
function Stat({ label, value }: { label: string; value: string | number }) {
  return (
    <div className="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div className="text-xs text-gray-500">{label}</div>
      <div className="text-2xl font-semibold">{value}</div>
    </div>
  );
}

export default function App() {
  const [state, setState] = useLocalState();
  const { settings, courses, sections, chosen } = state;
  const [tab, setTab] = useState<"tracker" | "maker" | "predict" | "settings">("tracker");

  const u = unitsByStatus(courses);
  const totalUnits = courses.reduce((s, c) => s + c.units, 0);
  const blocked = checkPrereqBlocks(courses);
  const conflictsList = useMemo(() => chosenConflicts(sections, chosen), [sections, chosen]);

  function addCourse() {
    setState(s => ({ ...s, courses: [...s.courses, { id: uid(), code: "NEW100", title: "New Course", units: 3, status: "Pending" }] }));
  }
  function updCourse(id: ID, patch: Partial<Course>) { setState(s => ({ ...s, courses: s.courses.map(c => c.id === id ? { ...c, ...patch } : c) })); }
  function delCourse(id: ID) { setState(s => ({ ...s, courses: s.courses.filter(c => c.id !== id), chosen: s.chosen.filter(cid => s.sections.find(x => x.id === cid)?.courseCode !== s.courses.find(c => c.id === id)?.code) })); }

  function addSection() {
    setState(s => ({ ...s, sections: [...s.sections, { id: uid(), courseCode: courses[0]?.code || "ECON111", section: "A1", days:["MO","WE"], start:"08:00", end:"09:00" }] }));
  }
  function updSection(id: ID, patch: Partial<Section>) { setState(s => ({ ...s, sections: s.sections.map(x => x.id === id ? { ...x, ...patch } : x) })); }
  function delSection(id: ID) { setState(s => ({ ...s, sections: s.sections.filter(x => x.id !== id), chosen: s.chosen.filter(cid => cid !== id) })); }
  function toggleChoose(id: ID) { setState(s => ({ ...s, chosen: s.chosen.includes(id) ? s.chosen.filter(x => x !== id) : [...s.chosen, id] })); }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="sticky top-0 z-10 border-b bg-white/70 backdrop-blur">
        <div className="mx-auto flex max-w-6xl items-center justify-between gap-3 px-4 py-3">
          <div className="flex items-center gap-2"><span className="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-emerald-600 text-white">ðŸŽ“</span><div>
            <div className="text-xs text-gray-500">FEU GradTrack</div>
            <div className="font-semibold">Course Tracker â€¢ Schedule Maker â€¢ Predictor</div></div></div>
          <nav className="flex gap-2 text-sm">
            {(["tracker","maker","predict","settings"] as const).map(t => (
              <button key={t} onClick={() => setTab(t)} className={`rounded-xl px-3 py-2 ring-1 ${tab===t?"bg-emerald-600 text-white ring-emerald-600":"bg-white ring-gray-200 hover:bg-gray-50"}`}>{t}</button>
            ))}
          </nav>
        </div>
      </header>

      <main className="mx-auto max-w-6xl space-y-6 px-4 py-4">
        {/* Overview */}
        <section className="grid grid-cols-2 gap-3 md:grid-cols-4">
          <Stat label="Passed Units" value={u.Passed} />
          <Stat label="Active Units" value={u.Active} />
          <Stat label="Pending Units" value={u.Pending} />
          <Stat label="Required Units" value={settings.requiredUnits} />
        </section>

        {/* Tracker Tab */}
        {tab === "tracker" && (
          <section className="grid gap-4 md:grid-cols-2">
            <div className="rounded-2xl border border-gray-200 bg-white p-4">
              <div className="mb-2 flex items-center justify-between">
                <h2 className="text-sm font-semibold">Course Tracker</h2>
                <button onClick={addCourse} className="rounded-xl border px-3 py-2 text-sm">+ Add Course</button>
              </div>
              <div className="mb-3 flex items-center gap-2 text-xs text-gray-600">
                <span>Blocked by prereqs:</span>
                {[...blocked].map(code => (<span key={code} className="rounded-full bg-amber-100 px-2 py-0.5 text-amber-800 ring-1 ring-amber-300">{code}</span>))}
                {blocked.size === 0 && <span className="text-emerald-600">None</span>}
              </div>
              <table className="w-full text-left text-sm">
                <thead className="bg-gray-50 text-xs text-gray-600"><tr><th className="p-2">Code</th><th className="p-2">Title</th><th className="p-2">Units</th><th className="p-2">Status</th><th className="p-2">Prereqs (;)</th><th className="p-2"></th></tr></thead>
                <tbody>
                  {courses.map(c => (
                    <tr key={c.id} className="border-b last:border-0">
                      <td className="p-2"><input className="w-28 rounded border px-2 py-1" value={c.code} onChange={e => updCourse(c.id,{code:e.target.value})} /></td>
                      <td className="p-2"><input className="w-full rounded border px-2 py-1" value={c.title} onChange={e => updCourse(c.id,{title:e.target.value})} /></td>
                      <td className="p-2"><input type="number" className="w-20 rounded border px-2 py-1" value={c.units} onChange={e => updCourse(c.id,{units:Number(e.target.value)})} /></td>
                      <td className="p-2"><select className="w-28 rounded border px-2 py-1" value={c.status} onChange={e => updCourse(c.id,{status:e.target.value as Status})}>
                        <option>Pending</option><option>Active</option><option>Passed</option>
                      </select></td>
                      <td className="p-2"><input className="w-48 rounded border px-2 py-1" value={(c.prereqs??[]).join(";")} onChange={e => updCourse(c.id,{prereqs:e.target.value.split(";").filter(Boolean)})} /></td>
                      <td className="p-2 text-right"><button onClick={()=>delCourse(c.id)} className="rounded border border-red-200 px-3 py-1 text-xs text-red-600">Delete</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="mt-3 text-xs text-gray-500">Tip: mark desired courses as <b>Active</b> then go to Schedule Maker.</div>
            </div>

            {/* Progress & Guidance */}
            <div className="rounded-2xl border border-gray-200 bg-white p-4">
              <h2 className="mb-2 text-sm font-semibold">Program Progress</h2>
              <div className="text-sm text-gray-700">{Math.round((u.Passed/settings.requiredUnits)*100)}% of required units completed.</div>
              <div className="mt-2 h-3 w-full rounded-full bg-gray-100"><div className="h-3 rounded-full bg-emerald-500" style={{width:`${Math.min(100,(u.Passed/settings.requiredUnits)*100)}%`}}/></div>
              <div className="mt-4 text-xs text-gray-500">Prereqs not strictly enforced for editing, but blocked list helps you plan.</div>
            </div>
          </section>
        )}

        {/* Schedule Maker */}
        {tab === "maker" && (
          <section className="grid gap-4 lg:grid-cols-3">
            <div className="rounded-2xl border border-gray-200 bg-white p-4 lg:col-span-2">
              <h2 className="mb-2 text-sm font-semibold">Weekly Calendar</h2>
              <Calendar sections={sections} chosen={chosen} />
              {conflictsList.length>0 && (
                <div className="mt-2 rounded-lg bg-amber-50 p-2 text-xs text-amber-800 ring-1 ring-amber-200">{conflictsList.length} conflict(s) detected. Adjust selections.</div>
              )}
              <div className="mt-3 flex gap-2">
                <button onClick={()=>exportICS(sections, chosen)} className="rounded-xl border px-3 py-2 text-sm">Export .ics</button>
              </div>
            </div>
            <div className="rounded-2xl border border-gray-200 bg-white p-4">
              <div className="mb-2 flex items-center justify-between"><h3 className="text-sm font-semibold">Available Sections</h3><button onClick={addSection} className="rounded-xl border px-3 py-2 text-sm">+ Add</button></div>
              <table className="w-full text-left text-sm">
                <thead className="bg-gray-50 text-xs text-gray-600"><tr><th className="p-2">Course</th><th className="p-2">Sec</th><th className="p-2">Days</th><th className="p-2">Time</th><th className="p-2">Room</th><th className="p-2">Pick</th><th></th></tr></thead>
                <tbody>
                  {sections
                    .filter(s => courses.find(c => c.code===s.courseCode)?.status === "Active")
                    .map(s => (
                      <tr key={s.id} className="border-b last:border-0">
                        <td className="p-2">{s.courseCode}</td>
                        <td className="p-2">{s.section}</td>
                        <td className="p-2">{s.days.join("")}</td>
                        <td className="p-2">{s.start}â€“{s.end}</td>
                        <td className="p-2">{s.room||""}</td>
                        <td className="p-2"><input type="checkbox" checked={chosen.includes(s.id)} onChange={()=>toggleChoose(s.id)} /></td>
                        <td className="p-2 text-right"><button onClick={()=>delSection(s.id)} className="rounded border border-red-200 px-3 py-1 text-xs text-red-600">Delete</button></td>
                      </tr>
                    ))}
                </tbody>
              </table>
              <div className="mt-2 text-xs text-gray-500">Only shows sections for <b>Active</b> courses. Add your section rows manually or from CSV later.</div>
            </div>
          </section>
        )}

        {/* Predictor */}
        {tab === "predict" && (
          <section className="grid gap-4 lg:grid-cols-2">
            <div className="rounded-2xl border border-gray-200 bg-white p-4">
              <h2 className="mb-2 text-sm font-semibold">Assumptions</h2>
              <div className="grid grid-cols-3 gap-2 text-sm">
                <label className="block"><span className="text-xs text-gray-500">Required Units</span><input type="number" className="w-full rounded border px-2 py-1" value={settings.requiredUnits} onChange={e=>setState(s=>({...s, settings:{...s.settings, requiredUnits:Number(e.target.value)}}))}/></label>
                <label className="block"><span className="text-xs text-gray-500">Max Units/Term</span><input type="number" className="w-full rounded border px-2 py-1" value={settings.maxUnitsPerTerm} onChange={e=>setState(s=>({...s, settings:{...s.settings, maxUnitsPerTerm:Number(e.target.value)}}))}/></label>
                <label className="block"><span className="text-xs text-gray-500">Summer Cap</span><input type="number" className="w-full rounded border px-2 py-1" value={settings.summerUnitsCap} onChange={e=>setState(s=>({...s, settings:{...s.settings, summerUnitsCap:Number(e.target.value)}}))}/></label>
              </div>
              <p className="mt-2 text-xs text-gray-500">Set your target load per term. Predictor uses simple packing logic (respecting prereqs that are already passed).</p>
            </div>
            <PredictorCard courses={courses} settings={settings} />
          </section>
        )}

        {/* Settings */}
        {tab === "settings" && (
          <section className="rounded-2xl border border-gray-200 bg-white p-4">
            <h2 className="mb-2 text-sm font-semibold">Backup</h2>
            <div className="flex gap-2">
              <button onClick={()=>{ const b=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download="feu-gradtrack.json"; a.click(); URL.revokeObjectURL(u); }} className="rounded-xl border px-3 py-2 text-sm">Export JSON</button>
              <label className="rounded-xl border px-3 py-2 text-sm">
                <input type="file" accept="application/json" className="hidden" onChange={e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(String(r.result)); setState(data as AppState);}catch{alert("Invalid JSON");} }; r.readAsText(f); }} />
                Import JSON
              </label>
            </div>
            <p className="mt-2 text-xs text-gray-500">Autosaves in your browser.</p>
          </section>
        )}
      </main>
    </div>
  );
}

/************** Subcomponents **************/
function Calendar({ sections, chosen }: { sections: Section[]; chosen: ID[] }) {
  const earliest = useMemo(() => fmtHM(Math.min(8*60, ...sections.filter(s=>chosen.includes(s.id)).map(s=>parseHM(s.start)), 9*60)), [sections, chosen]);
  const latest = useMemo(() => fmtHM(Math.max(17*60, ...sections.filter(s=>chosen.includes(s.id)).map(s=>parseHM(s.end)), 16*60)), [sections, chosen]);
  const startM = parseHM(earliest); const endM = parseHM(latest); const hours = (endM-startM)/60; const mark = Array.from({length: hours+1}, (_,i)=>startM+i*60);

  function colorFor(code: string) {
    const colors = ["bg-emerald-200 text-emerald-900","bg-sky-200 text-sky-900","bg-amber-200 text-amber-900","bg-rose-200 text-rose-900","bg-lime-200 text-lime-900","bg-fuchsia-200 text-fuchsia-900"];
    const idx = Math.abs(code.split("").reduce((a,c)=>a+c.charCodeAt(0),0)) % colors.length;
    return colors[idx];
  }

  return (
    <div className="overflow-hidden rounded-xl border">
      <div className="grid grid-cols-8 bg-gray-50 text-xs font-medium text-gray-600">
        <div className="p-2 text-center">Time</div>
        {daysOrder.map(d=>(<div key={d} className="p-2 text-center">{d}</div>))}
      </div>
      <div className="grid grid-cols-8">
        {/* time rail */}
        <div>{mark.map((m,i)=>(<div key={i} className="relative h-16 border-b"><div className="absolute left-1 top-1 text-[10px] text-gray-500">{fmtHM(m)}</div></div>))}</div>
        {daysOrder.map(day=> (
          <div key={day} className="relative">
            {mark.map((_,i)=>(<div key={i} className="h-16 border-b"/>))}
            {sections.filter(s=>chosen.includes(s.id) && s.days.includes(day)).map(s=>{
              const top = ((parseHM(s.start)-startM)/60)*64; const height = ((parseHM(s.end)-parseHM(s.start))/60)*64;
              return (
                <div key={s.id} className={`absolute left-1 right-1 rounded-md p-1 text-[11px] shadow ${colorFor(s.courseCode)}`} style={{top:top, height:height}}>
                  <div className="truncate font-medium">{s.courseCode} {s.section}</div>
                  <div className="truncate">{s.start}â€“{s.end}</div>
                  {s.room && <div className="truncate opacity-80">{s.room}</div>}
                </div>
              );
            })}
          </div>
        ))}
      </div>
    </div>
  );
}

function PredictorCard({ courses, settings }: { courses: Course[]; settings: Settings }) {
  // simple packing: count remaining units; estimate terms using caps (ignores offering windows)
  const passed = courses.filter(c => c.status === "Passed").reduce((s,c)=>s+c.units,0);
  const remainingUnits = Math.max(0, settings.requiredUnits - passed);
  const termsNeeded = Math.ceil(remainingUnits / settings.maxUnitsPerTerm);
  const monthsPerTerm = 5; // quick estimate
  const end = new Date(); end.setMonth(end.getMonth() + termsNeeded * monthsPerTerm);
  return (
    <div className="rounded-2xl border border-gray-200 bg-white p-4">
      <h2 className="mb-2 text-sm font-semibold">Graduation Prediction</h2>
      <div className="space-y-1 text-sm">
        <div><span className="text-gray-500">Remaining Units:</span> <span className="font-medium">{remainingUnits}</span></div>
        <div><span className="text-gray-500">Terms Needed (@{settings.maxUnitsPerTerm}/term):</span> <span className="font-medium">{termsNeeded}</span></div>
        <div><span className="text-gray-500">Estimated Completion:</span> <span className="font-medium">{end.toLocaleDateString()}</span></div>
      </div>
      <p className="mt-2 text-xs text-gray-500">For accuracy, model FEU academic calendars and real prereq chains later.</p>
    </div>
  );
}
